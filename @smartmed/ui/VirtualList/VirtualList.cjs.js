var re=require("./VirtualList.css");const s=require("vue"),$=require("../_plugin-vue_export-helper-f246444f.js"),O=5,P=(h,g)=>{const p={range:{},sizes:new Map,firstRangeTotalSize:0,firstRangeAverageSize:0,lastCalcIndex:0,fixedSizeValue:0,calcType:"INIT",direction:null,param:h,callUpdate:g,offset:0,destroy(){this.range={},this.sizes=new Map,this.firstRangeTotalSize=0,this.firstRangeAverageSize=0,this.lastCalcIndex=0,this.fixedSizeValue=0,this.calcType="INIT",this.offset=0,this.direction=null},getRange(){const{start:e,end:o,padFront:i,padBehind:r}=this.range;return{start:e,end:o,padFront:i,padBehind:r}},isBehind(){return this.direction==="BEHIND"},isFront(){return this.direction==="FRONT"},getOffset(e){return(e<1?0:this.getIndexOffset(e))+this.param.slotHeaderSize},updateParam(e,o){this.param&&e in this.param&&(e==="uniqueIds"&&this.sizes.forEach((i,r)=>{!o.includes(r)&&this.sizes.delete(r)}),this.param[e]=o)},saveSize(e,o){this.sizes.set(e,o),this.calcType==="INIT"?(this.fixedSizeValue=o,this.calcType="FIXED"):this.calcType==="FIXED"&&this.fixedSizeValue!==o&&(this.calcType="DYNAMIC",this.fixedSizeValue=null),this.calcType!=="FIXED"&&typeof this.firstRangeTotalSize<"u"&&(this.sizes.size<Math.min(this.param.keeps,this.param.uniqueIds.length)?(this.firstRangeTotalSize=[...this.sizes.values()].reduce((i,r)=>i+r,0),this.firstRangeAverageSize=Math.round(this.firstRangeTotalSize/this.sizes.size)):this.firstRangeTotalSize=null)},handleItemsChange(){let e=this.range.start;this.isFront()?e=e-O:this.isBehind()&&(e=e+O),e=Math.max(e,0),this.updateRange(this.range.start,this.getEndByStart(e))},handleSlotSizeChange(){this.handleItemsChange()},handleScroll(e){this.direction=e<this.offset?"FRONT":"BEHIND",this.offset=e,this.param&&(this.direction==="FRONT"?this.handleFront():this.direction==="BEHIND"&&this.handleBehind())},handleFront(){const e=this.getScrollOvers();if(this.range.start&&e>this.range.start)return;const o=Math.max(e-this.param.buffer,0);this.checkRange(o,this.getEndByStart(o))},handleBehind(){const e=this.getScrollOvers();this.range.start&&e<this.range.start+this.param.buffer||this.checkRange(e,this.getEndByStart(e))},getScrollOvers(){const e=this.offset-this.param.slotHeaderSize;if(e<=0)return 0;if(this.isFixedType())return Math.floor(e/this.fixedSizeValue);let o=0,i=0,r=0,d=this.param.uniqueIds.length;for(;o<=d;){if(i=o+Math.floor((d-o)/2),r=this.getIndexOffset(i),r===e)return i;r<e?o=i+1:r>e&&(d=i-1)}return o>0?--o:0},getIndexOffset(e){if(!e)return 0;let o=0,i;for(let r=0;r<e;r++)i=this.sizes.get(this.param.uniqueIds[r]),o=o+(typeof i=="number"?i:this.getEstimateSize());return this.lastCalcIndex=Math.max(this.lastCalcIndex,e-1),this.lastCalcIndex=Math.min(this.lastCalcIndex,this.getLastIndex()),o},isFixedType(){return this.calcType==="FIXED"},getLastIndex(){return this.param.uniqueIds.length-1},checkRange(e,o){const i=this.param.keeps;this.param.uniqueIds.length<=i?(e=0,o=this.getLastIndex()):o-e<i-1&&(e=o-i+1),this.range.start!==e&&this.updateRange(e,o)},updateRange(e,o){this.range.start=e,this.range.end=o,this.range.padFront=this.getPadFront(),this.range.padBehind=this.getPadBehind(),this.callUpdate(this.getRange())},getEndByStart(e){const o=e+this.param.keeps-1;return Math.min(o,this.getLastIndex())},getPadFront(){return this.isFixedType()?this.fixedSizeValue*this.range.start:this.getIndexOffset(this.range.start)},getPadBehind(){const e=this.range.end,o=this.getLastIndex();return this.isFixedType()?(o-e)*this.fixedSizeValue:this.lastCalcIndex===o?this.getIndexOffset(o)-this.getIndexOffset(e):(o-e)*this.getEstimateSize()},getEstimateSize(){return this.isFixedType()?this.fixedSizeValue:this.firstRangeAverageSize||this.param.estimateSize}};return h&&p.checkRange(0,h.keeps-1),p},A=s.defineComponent({name:"VirtualListItem",props:{horizontal:{type:Boolean}},setup(h,g){const{horizontal:p}=s.toRefs(h),e=s.ref(null);let o=null;const i=s.computed(()=>p.value?"offsetWidth":"offsetHeight");s.onMounted(()=>{typeof ResizeObserver<"u"&&e.value&&(o=new ResizeObserver(()=>{r()}),o.observe(e.value))});const r=()=>{g.emit("item-resize",d())},d=()=>e.value?e.value[i.value]:0;return s.onUpdated(()=>{r()}),s.onBeforeUnmount(()=>{o&&(o.disconnect(),o=null)}),{root:e}}}),U={ref:"root",role:"listitem"};function K(h,g,p,e,o,i){return s.openBlock(),s.createElementBlock("div",U,[s.renderSlot(h.$slots,"default")],512)}const T=$._export_sfc(A,[["render",K]]),X={items:()=>[],dataKey:"id",keeps:50,estimateSize:50,direction:"vertical",start:0,offset:0,topThreshold:0,bottomThreshold:0},W={name:"VirtualList"},Y=s.defineComponent({...W,props:s.mergeDefaults({items:{},dataKey:{},keeps:{},estimateSize:{},pageMode:{type:Boolean},direction:{},start:{},offset:{},topThreshold:{},bottomThreshold:{}},X),emits:["totop","tobottom"],setup(h,{expose:g,emit:p}){const e=h,{dataKey:o,items:i,direction:r,start:d,offset:I,topThreshold:V,bottomThreshold:N,keeps:w,pageMode:c}=s.toRefs(e),z=s.ref({}),l=s.ref(null),S=s.ref(null),L=t=>{z.value=t},R=s.computed(()=>i.value.map(t=>t[o.value])),f=s.computed(()=>r.value==="horizontal"),m=s.computed(()=>f.value?"scrollLeft":"scrollTop"),u=P({slotHeaderSize:0,slotFooterSize:0,keeps:e.keeps,estimateSize:e.estimateSize,buffer:Math.round(e.keeps/3),uniqueIds:R.value},L);s.onBeforeMount(()=>{v(u.offset)}),s.onMounted(()=>{d.value?k(d.value):I.value&&v(I.value),c.value&&(H(),document.addEventListener("scroll",_,{passive:!1}))});const k=t=>{if(t>=i.value.length-1)x();else{const n=u.getOffset(t);v(n)}},x=()=>{if(S.value){const t=S.value[f.value?"offsetLeft":"offsetTop"];v(t),setTimeout(()=>{B()+E()<F()&&x()})}},B=()=>c.value?document.documentElement[m.value]||document.body[m.value]:l.value?Math.ceil(l.value[m.value]):0,E=()=>{const t=f.value?"clientWidth":"clientHeight";return c.value?document.documentElement[t]||document.body[t]:l.value?Math.ceil(l.value[t]):0},F=()=>{const t=f.value?"scrollWidth":"scrollHeight";return c.value?document.documentElement[t]||document.body[t]:l.value?Math.ceil(l.value[t]):0},v=t=>{if(c.value){document.body[m.value]=t,document.documentElement[m.value]=t;return}l.value&&(l.value[m.value]=t)},H=()=>{if(!l.value)return;const t=l.value.getBoundingClientRect(),{defaultView:n}=l.value.ownerDocument;if(n){const a=f.value?t.left+n.pageXOffset:t.top+n.pageYOffset;u.updateParam("slotHeaderSize",a)}},D=(t,n,a)=>{u.isFront()&&i.value.length&&t-V.value<=0?p("totop"):u.isBehind()&&t+n+N.value>=a&&p("tobottom")},_=()=>{const t=B(),n=E(),a=F();t<0||t+n>a+1||!a||(u.handleScroll(t),D(t,n,a))};s.onBeforeUnmount(()=>{u.destroy(),c.value&&document.removeEventListener("scroll",_)});const b=s.computed(()=>{const{padBehind:t,padFront:n}=z.value;return{padding:f.value?`0px ${t}px 0px ${n}px`:`${n}px 0px ${t}px`}}),C=s.computed(()=>{const{start:t,end:n}=z.value;return t===void 0||n===void 0?i.value:i.value.slice(t,n+1)}),M=(t,n)=>{u.saveSize(t,n)},y=(t,n)=>{u.updateParam(t,n)};return s.watch(w,t=>{u.updateParam("keeps",t),u.handleSlotSizeChange()}),s.watch(d,t=>{k(t)}),s.watch(I,t=>{v(t)}),s.watch(i,()=>{u.updateParam("uniqueIds",R.value),u.handleItemsChange()}),g({root:l,shepherd:S,onScroll:_,groupStyle:b,isHorizontal:f,range:z,computedItems:C,onItemResized:M,onSlotResized:y,scrollToBottom:x}),(t,n)=>(s.openBlock(),s.createElementBlock("div",{ref_key:"root",ref:l,class:s.normalizeClass([!s.unref(c)&&t.$style.rootScrollable,!s.unref(c)&&t.$style["rootScrollable_"+s.unref(r)],t.$style.root,t.$style["root_"+s.unref(r)]]),onScroll:n[2]||(n[2]=a=>!s.unref(c)&&_())},[s.createVNode(T,{onItemResize:n[0]||(n[0]=a=>y("slotHeaderSize",a))},{default:s.withCtx(()=>[s.renderSlot(t.$slots,"before")]),_:3}),s.createElementVNode("div",{role:"group",class:s.normalizeClass([t.$style.group,t.$style["group_"+s.unref(r)]]),style:s.normalizeStyle(b.value)},[(s.openBlock(!0),s.createElementBlock(s.Fragment,null,s.renderList(C.value,a=>(s.openBlock(),s.createBlock(T,{key:a[s.unref(o)],onItemResize:q=>M(a.id,q)},{default:s.withCtx(()=>[s.renderSlot(t.$slots,"default",{item:a})]),_:2},1032,["onItemResize"]))),128))],6),s.createVNode(T,{onItemResize:n[1]||(n[1]=a=>y("slotFooterSize",a))},{default:s.withCtx(()=>[s.renderSlot(t.$slots,"after")]),_:3}),s.createElementVNode("div",{ref_key:"shepherd",ref:S,style:s.normalizeStyle({width:f.value?"0px":"100%",height:f.value?"100%":"0px"})},null,4)],34))}}),G="_rootScrollable_horizontal_1kox7_1",j="_rootScrollable_vertical_1kox7_4",J="_root_1kox7_1",Q="_group_1kox7_9",Z="_root_horizontal_1kox7_12",ee="_group_horizontal_1kox7_13",te="_root_vertical_1kox7_16",se="_group_vertical_1kox7_17",oe={rootScrollable_horizontal:G,rootScrollable_vertical:j,root:J,group:Q,root_horizontal:Z,group_horizontal:ee,root_vertical:te,group_vertical:se},ie={$style:oe},ne=$._export_sfc(Y,[["__cssModules",ie]]);module.exports=ne;
